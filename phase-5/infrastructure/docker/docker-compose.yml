version: '3.8'

services:
  # ============================================
  # Infrastructure Services
  # ============================================

  postgres:
    extends:
      file: ./postgres.yml
      service: postgres

  redis:
    extends:
      file: ./postgres.yml
      service: redis

  zookeeper:
    extends:
      file: ./kafka.yml
      service: zookeeper

  kafka:
    extends:
      file: ./kafka.yml
      service: kafka

  kafka-ui:
    extends:
      file: ./kafka.yml
      service: kafka-ui

  kafka-init:
    extends:
      file: ./kafka.yml
      service: kafka-init

  # ============================================
  # Application Services
  # ============================================

  backend:
    build:
      context: ../../backend
      dockerfile: Dockerfile
    container_name: phase5-backend
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: development
      PORT: 3001
      DATABASE_URL: postgresql://phase5_user:phase5_password@postgres:5432/phase5_todo
      JWT_SECRET: phase5-secret-key-change-in-production
      JWT_EXPIRES_IN: 7d
      KAFKA_BROKERS: kafka:29092
      DAPR_HTTP_PORT: 3500
      DAPR_GRPC_PORT: 50001
      CORS_ORIGIN: http://localhost:3000
      LOG_LEVEL: info
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: phase5_redis_password
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ../../backend/src:/app/src
      - ../../backend/prisma:/app/prisma
    networks:
      - phase5-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ../../frontend
      dockerfile: Dockerfile
      target: builder
    container_name: phase5-frontend
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3001
      NEXT_PUBLIC_WS_URL: ws://localhost:3001
      NEXT_TELEMETRY_DISABLED: 1
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ../../frontend/src:/app/src
      - ../../frontend/public:/app/public
    networks:
      - phase5-network
    restart: unless-stopped
    command: npm run dev

  # ============================================
  # Agent Services
  # ============================================

  audit-agent:
    build:
      context: ../../agents/audit-agent
      dockerfile: Dockerfile
    container_name: phase5-audit-agent
    environment:
      NODE_ENV: development
      KAFKA_BROKERS: kafka:29092
      KAFKA_GROUP_ID: audit-agent-group
      KAFKA_CLIENT_ID: audit-agent
      DATABASE_URL: postgresql://phase5_user:phase5_password@postgres:5432/phase5_todo
      LOG_LEVEL: info
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    volumes:
      - ../../agents/audit-agent/src:/app/src
    networks:
      - phase5-network
    restart: unless-stopped

  reminder-agent:
    build:
      context: ../../agents/reminder-agent
      dockerfile: Dockerfile
    container_name: phase5-reminder-agent
    environment:
      NODE_ENV: development
      KAFKA_BROKERS: kafka:29092
      KAFKA_GROUP_ID: reminder-agent-group
      KAFKA_CLIENT_ID: reminder-agent
      DATABASE_URL: postgresql://phase5_user:phase5_password@postgres:5432/phase5_todo
      LOG_LEVEL: info
      # SMTP Configuration (update with your SMTP settings)
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: 587
      SMTP_SECURE: false
      SMTP_USER: your-email@gmail.com
      SMTP_PASSWORD: your-app-password
      SMTP_FROM: Phase 5 Todo <noreply@phase5todo.com>
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    volumes:
      - ../../agents/reminder-agent/src:/app/src
    networks:
      - phase5-network
    restart: unless-stopped

  recurring-task-agent:
    build:
      context: ../../agents/recurring-task-agent
      dockerfile: Dockerfile
    container_name: phase5-recurring-task-agent
    environment:
      NODE_ENV: development
      KAFKA_BROKERS: kafka:29092
      KAFKA_GROUP_ID: recurring-task-agent-group
      KAFKA_CLIENT_ID: recurring-task-agent
      DATABASE_URL: postgresql://phase5_user:phase5_password@postgres:5432/phase5_todo
      LOG_LEVEL: info
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    volumes:
      - ../../agents/recurring-task-agent/src:/app/src
    networks:
      - phase5-network
    restart: unless-stopped

  realtime-sync-agent:
    build:
      context: ../../agents/realtime-sync-agent
      dockerfile: Dockerfile
    container_name: phase5-realtime-sync-agent
    environment:
      NODE_ENV: development
      KAFKA_BROKERS: kafka:29092
      KAFKA_GROUP_ID: realtime-sync-agent-group
      KAFKA_CLIENT_ID: realtime-sync-agent
      BACKEND_WS_URL: http://backend:3001
      LOG_LEVEL: info
    depends_on:
      backend:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    volumes:
      - ../../agents/realtime-sync-agent/src:/app/src
    networks:
      - phase5-network
    restart: unless-stopped

networks:
  phase5-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  zookeeper-data:
  zookeeper-logs:
  kafka-data:
